<!-- 
Expandable input. Takes a registry key value and shortens it to fit on the 
screen. When clicked on reveals an editable text box which is shifted into 
focus. Enter fires 'iron-form-submit' which sends the key, value pair as 
event.detail
 -->

<dom-module id="expandable-input">
  <style>
  #long{
    visibility: hidden;
    position: absolute;
    width: 80%;
  }
  </style>
  <template >
    <iron-a11y-keys keys="enter" on-keys-pressed="submitForm">
    <!-- TODO remap newline from enter to "ctrl enter" -->
      <div id="long">
        <textarea id="input" value="{{value::input}}" rows="[[compRows]]" cols="[[cols]]"></textarea>
      </div>
      <div id="short">
        <paper-item on-click="selectField" id="static" label="{{value_short}}">{{value_short}}</paper-item>
      </div>
    </iron-a11y-keys>
  </template>
  <script>
  Polymer({
    is: "expandable-input",
    properties: {
      name: {stype: String},
      value: {type: String},
      value_short: {
        //holds the shortened value which renders as 'value...' if longer than
        //cols
        type: String,
        computed: 'shortenValue(value)'
        },
        compRows: {
          //computed number of rows for input
          type: Number,
          value: 1
        },
        cols: {
          //number of characters in text field. Not sized dynamically. For now
          type: Number,
          value: 100
        }
    },
    behaviors: [
      Polymer.IronFormElementBehavior,
      Polymer.PaperInputBehavior,
      Polymer.IronControlState,
      Polymer.PaperInputBehaviorImpl
               ],
    ready: function() {
      //This focus-changed event handles the revealing and hiding of the static field
     this.addEventListener('focused-changed', this.fieldFocus);
    },
    calculateRows: function(value) {
      //calculates the number of rows in the editable input field
      console.log(this.cols,value.length,value.length/this.cols);
      return Math.ceil(value.length/this.cols); //number of rows in dialog rounded up
    },
    shortenValue: function(value) {
      //returned shortened string if longer than this.cols
      if (value.length>this.cols) {
        return value.substr(0,this.cols)+'...';
      }
      else {
        return value;
      }
    },
    fieldFocus: function() {
      /* When input field brought into focus this enlarges the input field.
      When focus is passed on, this shrinks the field and hides it behind the
      static label */
      if (this.focused){
        this.compRows = this.calculateRows(this.value);
      } else {
        this.compRows = 1;
        this.$.short.style.visibility = 'visible';
        this.$.long.style.visibility = 'hidden';
      } 
    },
    submitForm: function() {
      //fires submit so event is picked up by correct Polymer listener
      this.fire('iron-form-submit', [this.name, this.$.input.value]);
    },
    selectField: function() {
      //Hides static field to reveal multi-line input which is given focus
      this.$.short.style.visibility = 'hidden';
      this.$.long.style.visibility = 'visible';
      this.$$('textarea').focus();
    }
  });
  </script>
</dom-module>
